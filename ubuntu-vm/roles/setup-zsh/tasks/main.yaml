---
- name: Ensure that ZSH is installed.
  package:
    name:
      - zsh
    state: present

- name: Setup ZSH as user default shell.
  user:
    name: "{{ user_keybase }}"
    shell: /usr/bin/zsh

- name: Touch the ~/.zshrc file.
  file:
    path: "~/.zshrc"
    state: touch
    mode: "0644"
  become: false

- name: Initial setup of ZSH shell.
  command: ssh -q -o BatchMode=yes -o ConnectTimeout=3 \
    "{{ user_keybase }}"@"{{ ansible_host }}" "source ~/.zshrc && echo OK"
  become: false
  delegate_to: localhost
  changed_when: false

- name: Checkout kubectx ZSH plugin to non-buggy commit.
  git:
    repo: https://github.com/ahmetb/kubectx.git
    dest: "~/.oh-my-zsh/custom/plugins/kubectx/kubectx"
    version: "a50965728886c753031f687114c516651963141b"
    refspec: '+refs/heads/*:refs/remotes/origin/*'
  become: false
